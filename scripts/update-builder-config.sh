#!/usr/bin/env bash

set -e

SCRIPT_DIR=$(readlink -f "$(dirname "${BASH_SOURCE[0]}")")
# shellcheck disable=SC1090,SC1091
source "${SCRIPT_DIR}/common.sh"

enable_debug_mode_if_set

source "${SCRIPT_DIR}/check-for-gnu-tools.sh"

ROOT_DIR=$(readlink -f "${SCRIPT_DIR}/..")


ORIGINAL_CONFIG="${ROOT_DIR}/scalyr-opentelemetry-collector-contrib/cmd/otelcontribcol/builder-config.yaml"
TARGET_CONFIG="${ROOT_DIR}/otelcol-builder.datasetexporter-latest.yaml"


# add header
echo "# Generated by scripts/update-builder-config.sh" > "${TARGET_CONFIG}";
echo "# $(date --iso-8601=s) by ${USER} (${GITHUB_USERNAME}, ${GHE_APP})" >> "${TARGET_CONFIG}";

# copy original config
cat "${ORIGINAL_CONFIG}" >> "${TARGET_CONFIG}";

# update metadata
sed -i "" "s/description: .*/description: OpenTelemetry Collector Contrib Binary which contains latest version of the datasetexporter plugin from datasetexporter-latest branch from our from https:\/\/github.com\/scalyr\/opentelemetry-collector-contrib\/ and all other upstream otel contrib components/" "${TARGET_CONFIG}";
sed -i "" '/description: /a\
  output_path: .\/_build
  ' "${TARGET_CONFIG}";
sed -i "" "s/name: .*/name: otelcol-contrib-datasetexporter-latest/" "${TARGET_CONFIG}";
sed -i "" "s/\( version: .*\)/\1-datasetexporter-latest/" "${TARGET_CONFIG}";
sed -i "" "/module: /d" "${TARGET_CONFIG}";

# remove all replaces
sed -ri "" "/ +=> +..\/..\//d" "${TARGET_CONFIG}";

# add replaces related to datasetexporter
echo "  - github.com/open-telemetry/opentelemetry-collector-contrib/exporter/datasetexporter => github.com/scalyr/opentelemetry-collector-contrib/exporter/datasetexporter datasetexporter-latest" >> "${TARGET_CONFIG}";
echo "  - github.com/scalyr/dataset-go => ./../dataset-go" >> "${TARGET_CONFIG}";
